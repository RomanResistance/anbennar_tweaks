namespace = infestation_goblin

# for testing, use event infestation_goblin.0 to force spawn in one of your provinces

# notes on goblins:
# goblin infestations have three sizes, 1, 2, 3 with three being the largest
# goblins can be civilized as racial minority
# goblins can rebel at size 2 or 3, with demands to civilize

# possible flags and province modifiers
# infestation_present - province flag, universal
# infestation_goblin_1, infestation_goblin_2, infestation_goblin_3 for sizes of goblins
# infestation_goblin_stronghold - modifier which affects the fort maintenance/defensiveness.
# infestation_goblin_rebels - country flag so that we can clean up after a rebellion

# spawn goblin infestation in this province and start event loop
province_event = {
    id = infestation_goblin.0
    title = infestation_goblin.0.t
    desc = infestation_goblin.0.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = yes
    is_triggered_only = yes
    
    immediate = {
        hidden_effect = {
            set_province_flag = infestation_present # important; or event loop will exit
        }
    }
    
    option = {
        ai_chance = { factor = 100 }
        add_province_modifier = {
            name = infestation_goblin_1
            duration = -1  
            desc = infestation_goblin_1_tooltip
        }
        province_event = { id = infestation_goblin.100 days = 1 } # spawn response event
    }
    after = {
        # first event in half a year, ish; start event loop
        province_event = { id = infestation_goblin.1 days = 100 random = 100 }
    }
}

# random event dispatcher, on a loop until infestation_present is removed
province_event = {
    id = infestation_goblin.1
    title = infestation_goblin.1.t
    desc = infestation_goblin.1.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = yes
    is_triggered_only = yes
    

    trigger = {
        has_province_flag = infestation_present
        OR = { 
            has_province_modifier = infestation_goblin_1
            has_province_modifier = infestation_goblin_2
            has_province_modifier = infestation_goblin_3
        }
    }

    option = {
        # vanish
        trigger = { has_province_modifier = infestation_goblin_1 }
        ai_chance = { factor = 1 }
        province_event = { id = infestation_goblin.101 }
    }
    
    option = {
        # migrate internally
        trigger = {
            NOT = { has_province_modifier = infestation_goblin_stronghold } # stops migration
            owner = { num_of_cities = 2 } # you have something to migrate to
            any_neighbor_province = { 
                owned_by = ROOT
                NOT = { has_province_flag = infestation_present }
            }
        }
        ai_chance = { factor = 1 }
        province_event = { id = infestation_goblin.110 }
    }
        
    option = {
        # migrate across border
        trigger = {
            NOT = { has_province_modifier = infestation_goblin_stronghold } # stops migration
            any_neighbor_province = { 
                NOT = { owned_by = ROOT }
                NOT = { has_province_flag = infestation_present }
            }
        }
        ai_chance = { factor = 1 }
        province_event = { id = infestation_goblin.111 }
    }
    
    option = {
        # banish (migrate to random neighbour)
        ai_chance = { 
            factor = 1
            modifier = {
                factor = 3 # more likely if generous quest rewards/adverturer nation
                OR = {
                    owner = { has_estate_privilege = estate_adventurers_generous_quest_rewards }
                    owner = { has_reform = adventurer }
                }
            }
            modifier = {
                factor = 5 # if being expelled through racial menu
                owner = { has_country_modifier = racial_pop_goblin_expulsion }
            }
        }
        province_event = { id = infestation_goblin.115 }
    }
    
    option = {
        # spread internally
        trigger = { 
            OR = { 
                has_province_modifier = infestation_goblin_2 
                has_province_modifier = infestation_goblin_3
            }
        }
        ai_chance = { factor = 2 }
        province_event = { id = infestation_goblin.120 }
    }
    
    option = {
        # spread across border
        trigger = { 
            OR = { 
                has_province_modifier = infestation_goblin_2 
                has_province_modifier = infestation_goblin_3
            }
        }
        ai_chance = { factor = 2 } # spreading is good
        province_event = { id = infestation_goblin.121 }
    }
    
    option = {
        # grows
        trigger = { 
            OR = { 
                has_province_modifier = infestation_goblin_1 
                has_province_modifier = infestation_goblin_2
            }
        }
        ai_chance = { factor = 2 } # we like growth opportunities
        province_event = { id = infestation_goblin.130 }
    }

    option = {
        # shrinks
        trigger = { 
            OR = { 
                has_province_modifier = infestation_goblin_2 
                has_province_modifier = infestation_goblin_3
            }
        }
        ai_chance = { factor = 1 }
        province_event = { id = infestation_goblin.131 }
    }
    
    option = {
        # devastation
        ai_chance = { factor = 1 }
        province_event = { id = infestation_goblin.140 }
    }
    
    option = {
        # provoke rebellion
        trigger = { 
            OR = { 
                has_province_modifier = infestation_goblin_2 
                has_province_modifier = infestation_goblin_3
            }
        }
        ai_chance = { 
            factor = 1
            modifier = {
                factor = 3 # more likely if generous quest rewards/adverturer nation
                OR = {
                    owner = { has_estate_privilege = estate_adventurers_generous_quest_rewards }
                    owner = { has_reform = adventurer }
                }
            }
        }
        province_event = { id = infestation_goblin.146 }
    }
    option = {
        # infestation killed -> shrinks/vanishes
        ai_chance = { 
            factor = 1
            modifier = {
                factor = 3 # more likely if generous quest rewards/adverturer nation
                OR = {
                    owner = { has_estate_privilege = estate_adventurers_generous_quest_rewards }
                    owner = { has_reform = adventurer }
                }
            }
            modifier = {
                factor = 5 # if being purged through racial menu
                owner = { has_country_modifier = racial_pop_goblin_purge }
            }
        }
        province_event = { id = infestation_goblin.150 }
    }
    
    option = {
        # civilizes
        ai_chance = { 
            factor = 1
            modifier = {
                factor = 3 # more likely if generous quest rewards/adverturer nation
                OR = {
                    owner = { has_estate_privilege = estate_adventurers_generous_quest_rewards }
                    owner = { has_reform = adventurer }
                }
            }
            modifier = {
                factor = 5 # goblins infest a goblin nation! Let's incorporate them!
                OR = {
                    owner = { culture_group = goblin } # country is in culture group
                    owner = { has_goblin_accepted_culture = yes }
                    culture_group = goblin # province is in culture group
                }
            }
            modifier = {
                factor = 5 # goblins already in province, and are an integrated minority
                OR = {
                    has_goblin_minority_trigger = yes
                    has_goblin_majority_trigger = yes
                }
                owner = { has_integrated_goblin_pop_trigger = yes }
            }
        }
        province_event = { id = infestation_goblin.160 }
    }
    
    option = {
        # builds stronghold - this is the signature event of goblins
        trigger = { 
            OR = { 
                has_province_modifier = infestation_goblin_2 
                has_province_modifier = infestation_goblin_3
            }
            NOT = { has_province_modifier = infestation_goblin_stronghold }
        }
        ai_chance = { factor = 5 } # signature event
        province_event = { id = infestation_goblin.200 }
    }

    
    after = {
        # loop this random event dispatcher
        # about a year between events
        province_event = { id = infestation_goblin.1 days = 300 random = 100 }
    }
}


# notification of infestation spawning
province_event = {
    id = infestation_goblin.100
    title = infestation_goblin.100.t
    desc = infestation_goblin.100.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    option = {
        # what's the worst that can happen?
        name = infestation_goblin.100.a
        ai_chance = { factor = 50 }
    }
    option = {
        # grant adventurer's generous rewards to look after it
        name = infestation_goblin.100.b
        ai_chance = { 
            factor = 20 
            modifier = {
                factor = 0
                owner = { is_in_deficit = yes }
            }
        }
        trigger = {
            owner = { has_estate = estate_adventurers }
            owner = { NOT = { has_estate_privilege = estate_adventurers_generous_quest_rewards } }
        }
        owner = { set_estate_privilege = estate_adventurers_generous_quest_rewards }
    }
    option = {
        # the adventurer's are on it
        name = infestation_goblin.100.c
        ai_chance = { factor = 50 }
        trigger = {
            owner = { has_estate = estate_adventurers }
            owner = { has_estate_privilege = estate_adventurers_generous_quest_rewards }
        }
    }
    option = {
        # we are adventurers, deal with it ourselves!
        name = infestation_goblin.100.e
        ai_chance = { factor = 50 }
        trigger = {
            owner = { has_reform = adventurer }
        }
    }
}

# infestation vanishes on its own
province_event = {
    id = infestation_goblin.101
    title = infestation_goblin.101.t
    desc = infestation_goblin.101.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        has_province_flag = infestation_present
        has_province_modifier = infestation_goblin_1
    }
    
    option = {
        # oh, thank goodness
        name = infestation_goblin.101.a
        ai_chance = { factor = 100 }
        remove_province_modifier = infestation_goblin_1
        clr_province_flag = infestation_present
    }
    after = {
        hidden_effect = {
            province_event = { id = infestation_goblin.201 days = 30 } # deal with stronghold
        }
    }
}

# infestation migrates to adjacent province internally event
province_event = {
    id = infestation_goblin.110
    title = infestation_goblin.110.t
    desc = infestation_goblin.110.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = yes
    is_triggered_only = yes
    
    trigger = {
        owner = { num_of_cities = 2 } # you have something to migrate to
        any_neighbor_province = { 
            owned_by = ROOT
            NOT = { has_province_flag = infestation_present }
            has_influencing_fort = no # forts prevent infestations from spawning if active
        }
    }
    
    immediate = {
        hidden_effect = {
            random_neighbor_province = {
                limit = {
                    owned_by = ROOT
                    NOT = { has_province_flag = infestation_present }
                    has_influencing_fort = no # forts prevent infestations from spawning if active
                }
                save_event_target_as = infestation_migration_target
            }
            event_target:infestation_migration_target = {
                set_province_flag = infestation_present
            }
            remove_province_modifier = infestation_goblin_stronghold # just in case
            clr_province_flag = infestation_present
        }
    }
    option = {
        name = infestation_goblin.110.a
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        trigger = {
            has_province_modifier = infestation_goblin_3
        }
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_3
                duration = -1  
                desc = infestation_goblin_3_tooltip
            }
        }
        remove_province_modifier = infestation_goblin_3
    }    
    option = {
        name = infestation_goblin.110.b
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        trigger = {
            has_province_modifier = infestation_goblin_2
        }
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_2
                duration = -1  
                desc = infestation_goblin_2_tooltip
            }
        }
        remove_province_modifier = infestation_goblin_2
    }    
    option = {
        name = infestation_goblin.110.c
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        trigger = {
            has_province_modifier = infestation_goblin_1
        }
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_1
                duration = -1  
                desc = infestation_goblin_1_tooltip
            }
        }
        remove_province_modifier = infestation_goblin_1
    }    
    
    after = {
        # first event in half a year, ish
        event_target:infestation_migration_target = {
            province_event = { id = infestation_goblin.1 days = 100 random = 100 }
        }
    }
}

# infestation migrates across border to adjacent province event
province_event = {
    id = infestation_goblin.111
    title = infestation_goblin.111.t
    desc = infestation_goblin.111.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        any_neighbor_province = { 
            NOT = { owned_by = ROOT }
            NOT = { has_province_flag = infestation_present }
            has_influencing_fort = no # forts prevent infestations from spawning if active
        }
    }
    
    immediate = {
        hidden_effect = {
            random_neighbor_province = {
                limit = {
                    NOT = { owned_by = ROOT }
                    NOT = { has_province_flag = infestation_present }
                    has_influencing_fort = no # forts prevent infestations from spawning if active
                }
                save_event_target_as = infestation_migration_target
            }
            event_target:infestation_migration_target = {
                set_province_flag = infestation_present
            }
            remove_province_modifier = infestation_goblin_stronghold # just in case
            clr_province_flag = infestation_present
        }
    }
    
    option = {
        name = infestation_goblin.111.a
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        trigger = {
            has_province_modifier = infestation_goblin_3
        }
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_3
                duration = -1  
                desc = infestation_goblin_3_tooltip
            }
        }
        remove_province_modifier = infestation_goblin_3
    }
    option = {
        name = infestation_goblin.111.b
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        trigger = {
            has_province_modifier = infestation_goblin_2
        }
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_2
                duration = -1  
                desc = infestation_goblin_2_tooltip
            }
        }
        remove_province_modifier = infestation_goblin_2
    }
    option = {
        name = infestation_goblin.111.c
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        trigger = {
            has_province_modifier = infestation_goblin_1
        }
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_1
                duration = -1  
                desc = infestation_goblin_1_tooltip
            }
        }
        remove_province_modifier = infestation_goblin_1
    }
    after = {
        event_target:infestation_migration_target = {
            province_event = { id = infestation_goblin.112 }
        }
    }
}

# infestation migrated/spread across border into this province event
# basically the same as infestation_goblin.100, but with opinion modifier
# and more flavourful descriptions
province_event = {
    id = infestation_goblin.112
    title = infestation_goblin.112.t
    desc = infestation_goblin.112.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    immediate = {
    }
    option = {
        # How could they do this to us!?
        name = infestation_goblin.112.a
        ai_chance = { factor = 50 }
        owner = {
            add_opinion = {
                who = FROM
                modifier = infestation_crossed_border
            }
        }
    }
    option = {
        # grant adventurer's generous rewards to look after it
        name = infestation_goblin.112.b
        ai_chance = { 
            factor = 20 
            modifier = {
                factor = 0
                owner = { is_in_deficit = yes }
            }
        }
        trigger = {
            owner = { has_estate = estate_adventurers }
            owner = { NOT = { has_estate_privilege = estate_adventurers_generous_quest_rewards } }
        }
        owner = { set_estate_privilege = estate_adventurers_generous_quest_rewards }
        owner = {
            add_opinion = {
                who = FROM
                modifier = infestation_crossed_border
            }
        }
    }
    option = {
        # the adventurer's are on it
        name = infestation_goblin.112.c
        ai_chance = { factor = 50 }
        trigger = {
            owner = { has_estate = estate_adventurers }
            owner = { has_estate_privilege = estate_adventurers_generous_quest_rewards }
        }
        owner = {
            add_opinion = {
                who = FROM
                modifier = infestation_crossed_border
            }
        }
    }
    option = {
        # we are adventurers, deal with it ourselves!
        name = infestation_goblin.112.e
        ai_chance = { factor = 50 }
        trigger = {
            owner = { has_reform = adventurer }
        }
        owner = {
            add_opinion = {
                who = FROM
                modifier = infestation_crossed_border
            }
        }
    }
    
    after = {
        # first event in half a year, ish
        province_event = { id = infestation_goblin.1 days = 100 random = 100 }
    }
}

# banished (migrate to a neighbour at random)
province_event = {
    id = infestation_goblin.115
    title = infestation_goblin.115.t
    desc = infestation_goblin.115.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
        
    trigger = {
        owner = {
            any_neighbor_country = {
                any_owned_province = {
                    NOT = { has_province_flag = infestation_present }
                    has_influencing_fort = no # forts prevent infestations from spawning if active
                }
            }
        }
    }
    
    immediate = {
        hidden_effect = {
            owner = {
                random_neighbor_country = {
                    limit = {
                        any_owned_province = {
                            NOT = { has_province_flag = infestation_present }
                            has_influencing_fort = no # active forts prevent infestations from spawning 
                        }
                    }
                    save_event_target_as = infestation_migration_country_target
                }
            }
            event_target:infestation_migration_country_target = {
                random_owned_province = {
                    limit = { 
                        NOT = { has_province_flag = infestation_present } 
                        has_influencing_fort = no # forts prevent infestations from spawning if active
                    }
                    save_event_target_as = infestation_migration_target
                }
            }
            event_target:infestation_migration_target = {
                set_province_flag = infestation_present
            }
            clr_province_flag = infestation_present
        }
    }
    
    option = {
        name = infestation_goblin.115.a
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        trigger = {
            has_province_modifier = infestation_goblin_3
        }
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_3
                duration = -1  
                desc = infestation_goblin_3_tooltip
            }
        }
        remove_province_modifier = infestation_goblin_3
    }
    option = {
        name = infestation_goblin.115.b
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        trigger = {
            has_province_modifier = infestation_goblin_2
        }
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_2
                duration = -1  
                desc = infestation_goblin_2_tooltip
            }
        }
        remove_province_modifier = infestation_goblin_2
    }
    option = {
        name = infestation_goblin.115.c
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        trigger = {
            has_province_modifier = infestation_goblin_1
        }
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_1
                duration = -1  
                desc = infestation_goblin_1_tooltip
            }
        }
        remove_province_modifier = infestation_goblin_1
    }
    after = {
        event_target:infestation_migration_target = {
            province_event = { id = infestation_goblin.112 }
        }
        if = {
            limit = { owner = { has_estate_privilege = estate_adventurers_generous_quest_rewards } }
            owner = {
                add_estate_influence_modifier = {
                    estate = estate_adventurers
                    desc = handled_infestation
                    duration = 3650
                    influence = 5
                }
            }
        }
        hidden_effect = {
            province_event = { id = infestation_goblin.201 days = 30 } # deal with stronghold
        }
    }
}

# infestation spreads to adjacent province internally event
province_event = {
    id = infestation_goblin.120
    title = infestation_goblin.120.t
    desc = infestation_goblin.120.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        owner = { num_of_cities = 2 } # you have something to migrate to
        any_neighbor_province = { 
            owned_by = ROOT
            NOT = { has_province_flag = infestation_present }
            has_influencing_fort = no # forts prevent infestations from spawning if active
        }
        OR = {
            has_province_modifier = infestation_goblin_3
            has_province_modifier = infestation_goblin_2
        }
    }
    immediate = {
        hidden_effect = {
            random_neighbor_province = {
                limit = {
                    owned_by = ROOT
                    NOT = { has_province_flag = infestation_present }
                    has_influencing_fort = no # forts prevent infestations from spawning if active
                }
                save_event_target_as = infestation_spread_target
            }
            event_target:infestation_spread_target = {
                set_province_flag = infestation_present
            }
        }
    }
    option = {
        name = infestation_goblin.120.a
        ai_chance = { factor = 100 }
        goto = infestation_spread_target
        event_target:infestation_spread_target = {
            add_province_modifier = {
                name = infestation_goblin_1
                duration = -1  
                desc = infestation_goblin_1_tooltip
            }
        }
    }
    after = {
        # first event in half a year, ish
        event_target:infestation_spread_target = {
            province_event = { id = infestation_goblin.1 days = 100 random = 100 }
        }
    }
}

# infestation spreads across border to adjacent province event
province_event = {
    id = infestation_goblin.121
    title = infestation_goblin.121.t
    desc = infestation_goblin.121.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        any_neighbor_province = { 
            NOT = { owned_by = ROOT }
            NOT = { has_province_flag = infestation_present }
            has_influencing_fort = no # forts prevent infestations from spawning if active
        }
        OR = {
            has_province_modifier = infestation_goblin_3
            has_province_modifier = infestation_goblin_2
        }
    }
    immediate = {
        hidden_effect = {
            random_neighbor_province = {
                limit = {
                    NOT = { owned_by = ROOT }
                    NOT = { has_province_flag = infestation_present }
                    has_influencing_fort = no # forts prevent infestations from spawning if active
                }
                save_event_target_as = infestation_migration_target
            }
            event_target:infestation_migration_target = {
                set_province_flag = infestation_present
            }
        }
    }
    option = {
        name = infestation_goblin.121.a
        ai_chance = { factor = 100 }
        goto = infestation_migration_target
        event_target:infestation_migration_target = {
            add_province_modifier = {
                name = infestation_goblin_1
                duration = -1  
                desc = infestation_goblin_1_tooltip
            }
        }
    }
    after = {
        event_target:infestation_migration_target = {
            province_event = { id = infestation_goblin.112 }
        }
    }
}

# infestation grows in strength
province_event = {
    id = infestation_goblin.130
    title = infestation_goblin.130.t
    desc = infestation_goblin.130.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        has_province_flag = infestation_present
        OR = { 
            has_province_modifier = infestation_goblin_1 
            has_province_modifier = infestation_goblin_2
        }
    }
    option = {
        # should we be worried?
        name = infestation_goblin.130.a
        ai_chance = { factor = 100 }
        if = {
            limit = { has_province_modifier = infestation_goblin_2 }
            hidden_effect = { remove_province_modifier = infestation_goblin_2 }
            add_province_modifier = {
                name = infestation_goblin_3
                duration = -1  
                desc = infestation_goblin_3_tooltip
            }
        }
        if = {
            limit = { has_province_modifier = infestation_goblin_1 }
            hidden_effect = { remove_province_modifier = infestation_goblin_1 }
            add_province_modifier = {
                name = infestation_goblin_2
                duration = -1  
                desc = infestation_goblin_2_tooltip
            }
        }
    }
}

# infestation shrinks in strength
province_event = {
    id = infestation_goblin.131
    title = infestation_goblin.131.t
    desc = infestation_goblin.131.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        has_province_flag = infestation_present
        OR = { 
            has_province_modifier = infestation_goblin_2 
            has_province_modifier = infestation_goblin_3
        }
    }
    
    option = {
        # should we be worried?
        name = infestation_goblin.131.a
        ai_chance = { factor = 100 }
        if = {
            limit = { has_province_modifier = infestation_goblin_2 }
            hidden_effect = { remove_province_modifier = infestation_goblin_2 }
            add_province_modifier = {
                name = infestation_goblin_1
                duration = -1  
                desc = infestation_goblin_1_tooltip
            }
        }
        if = {
            limit = { has_province_modifier = infestation_goblin_3 }
            hidden_effect = { remove_province_modifier = infestation_goblin_3 }
            add_province_modifier = {
                name = infestation_goblin_2
                duration = -1  
                desc = infestation_goblin_2_tooltip
            }
        }
    }
}

# devastation
province_event = {
    id = infestation_goblin.140
    title = infestation_goblin.140.t
    desc = infestation_goblin.140.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    option = {
        name = infestation_goblin.140.a
        ai_chance = { factor = 20 }
        add_devastation = 5
    }
    option = {
        # crack down hard
        name = infestation_goblin.140.b
        trigger = { 
            OR = { 
                has_province_modifier = infestation_goblin_2 
                has_province_modifier = infestation_goblin_3
            }
        }
        ai_chance = { factor = 80 }
        add_devastation = 10
        province_event = { id = infestation_goblin.131 days = 30 } # shrinks in size
    }
    option = {
        # wipe them out
        name = infestation_goblin.140.c
        trigger = { 
            has_province_modifier = infestation_goblin_1 
        }
        ai_chance = { factor = 80 }
        add_devastation = 15
        province_event = { id = infestation_goblin.101 days = 30 } # vanishes
    }
}

# adventurers provoke rebellion
province_event = {
    id = infestation_goblin.146
    title = infestation_goblin.146.t
    desc = infestation_goblin.146.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
        
    option = {
        # provoke them!
        name = infestation_goblin.146.a
        ai_chance = { factor = 50 }
        set_country_flag = infestation_goblin_rebels
        spawn_rebels = {
            type = infestation_goblin_rebels
            size = 1
        }
        # signature goblin effect - if they built a stronghold, they
        # get immediate occupation of that province, and level 1 fort
        hidden_effect = {
            owner = {
                every_owned_province = {
                    if = {
                        limit = { has_province_modifier = infestation_goblin_stronghold }
                        change_controller = REB
                    }
                }
            }
        }
    }
    option = {
        # a terrible idea
        name = infestation_goblin.146.b
        ai_chance = { factor = 50 }
    }
}

# post rebellion cleanup - goblins removed from country
country_event = {
    id = infestation_goblin.148
    title = infestation_goblin.148.t
    desc = infestation_goblin.148.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        has_country_flag = infestation_goblin_rebels
        FROM = {
            tag = REB
        }
        NOT = { has_spawned_rebels = infestation_goblin_rebels }
    }
    option = {
        # goblins utterly defeated
        name = infestation_goblin.148.a
        clr_country_flag = infestation_goblin_rebels
        hidden_effect = {
            every_owned_province = {
                limit = {
                    OR = {
                        has_province_modifier = infestation_goblin_1
                        has_province_modifier = infestation_goblin_2
                        has_province_modifier = infestation_goblin_3
                    }
                }
                remove_province_modifier = infestation_goblin_1
                remove_province_modifier = infestation_goblin_2
                remove_province_modifier = infestation_goblin_3
                remove_province_modifier = infestation_goblin_stronghold
                clr_province_flag = infestation_present
            }
        }
    }
}

# kill goblins
province_event = {
    id = infestation_goblin.150
    title = infestation_goblin.150.t
    desc = infestation_goblin.150.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        has_province_flag = infestation_present
    }
    
    option = {
        # great job!
        name = infestation_goblin.150.a
        ai_chance = { factor = 100 }
        remove_province_modifier = infestation_goblin_1
        remove_province_modifier = infestation_goblin_2
        remove_province_modifier = infestation_goblin_3
        clr_province_flag = infestation_present
        owner = {
            add_estate_influence_modifier = {
                estate = estate_adventurers
                desc = handled_infestation
                duration = 3650
                influence = 5
            }
        }
    }
    after = {
        hidden_effect = {
            province_event = { id = infestation_goblin.201 days = 30 } # deal with stronghold
        }
    }
}

# infestation, if possible race, becomes minority (civilized)
province_event = {
    id = infestation_goblin.160
    title = infestation_goblin.160.t
    desc = infestation_goblin.160.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        has_province_flag = infestation_present
    }
    
    option = {
        # An interesting turn of events
        name = infestation_goblin.160.a
        ai_chance = { 
            factor = 80 
            modifier = {
                factor = 0
                owner = { culture_group = dwarven } # dwarves hate gobbos 
            }
            modifier = {
                factor = 100
                OR = {
                    owner = { culture_group = goblin } # country is in culture group
                    owner = { has_goblin_accepted_culture = yes }
                    culture_group = goblin # province is in culture group
                    has_goblin_minority_trigger = yes
                    has_goblin_majority_trigger = yes
                    owner = { has_integrated_goblin_pop_trigger = yes }
                }
            }
        }
        if = {
            limit = { has_province_modifier = infestation_goblin_1 }
            add_goblin_minority_size_effect = yes
            remove_province_modifier = infestation_goblin_1
        }
        if = {
            limit = { has_province_modifier = infestation_goblin_2 }
            add_goblin_minority_size_effect = yes
            remove_province_modifier = infestation_goblin_2
        }
        if = {
            limit = { has_province_modifier = infestation_goblin_3 }
            add_goblin_minority_size_effect = yes
            add_goblin_minority_size_effect = yes
            remove_province_modifier = infestation_goblin_3
        }
        small_increase_of_goblin_tolerance_effect = yes
        clr_province_flag = infestation_present
        hidden_effect = {
            province_event = { id = infestation_goblin.201 days = 30 } # deal with stronghold
        }
    }
    option = {
        # No way!
        name = infestation_goblin.160.b
        ai_chance = { 
            factor = 20 
        }
    }
}

# builds stronghold (builds fort)
province_event = {
    id = infestation_goblin.200
    title = infestation_goblin.200.t
    desc = infestation_goblin.200.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    option = {
        name = infestation_goblin.200.a
        ai_chance = { factor = 100 }
        add_province_modifier = {
            name = infestation_goblin_stronghold
            duration = 3650 
            desc = infestation_goblin_stronghold_tooltip
        }
    }
}

# deal with goblin stronghold after integrating goblins
province_event = {
    id = infestation_goblin.201
    title = infestation_goblin.201.t
    desc = infestation_goblin.201.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        has_province_modifier = infestation_goblin_stronghold
    }
        
    option = {
        # shore it up to create real fort
        name = infestation_goblin.201.a
        ai_chance = { 
            factor = 50 
            modifier = {
                factor = 0
                owner = { is_in_deficit = yes }
            }
        }
        remove_province_modifier = infestation_goblin_stronghold
        add_building = fort_15th
        add_treasury = -50
        small_increase_of_goblin_tolerance_effect = yes
    }
    option = {
        # tear it down, who would maintain such an ugly fort
        name = infestation_goblin.201.b
        ai_chance = { factor = 50 }
        remove_province_modifier = infestation_goblin_stronghold
        small_decrease_of_goblin_tolerance_effect = yes
    }
}

# cleanup event; wipes all trace of this infestation from the province
# this is useful for debugging
province_event = {
    id = infestation_goblin.2000
    title = infestation_goblin.2000.t
    desc = infestation_goblin.2000.d
    picture = COMET_SIGHTED_eventPicture
    goto = ROOT
    
    hidden = yes
    is_triggered_only = yes
    
    option = {
        # cleanup; hidden
        name = infestation_goblin.2000.a
        ai_chance = { factor = 100 }
        remove_province_modifier = infestation_goblin_1
        remove_province_modifier = infestation_goblin_2
        remove_province_modifier = infestation_goblin_3
        remove_province_modifier = infestation_goblin_stronghold
        clr_province_flag = infestation_present
    }
}
